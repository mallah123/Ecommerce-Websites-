{% extends 'app/base.html' %}
{% load static %}
{% block title %}Buy Now{% endblock title %}
{% block main-content %}
<div class="container mt-5">
  <div class="row">
    <!-- Order Summary -->
    <div class="col-md-8 mb-4">
      <h4>Order Summary</h4>
      <hr />
      {% for item in cart_items %}
      <div class="card mb-2">
        <div class="card-body">
          <h5>Product: {{ item.product.title }}</h5>
          <p>Quantity: {{ item.quantity }}</p>
          <p class="fw-bold">Price: Rs. {{ item.total_amount }}</p>
        </div>
      </div>
      {% endfor %}
      <p>
        <strong>Total Cost + Shipping Cost (Rs. 50) = Rs. {{ total_amount }}</strong>
      </p>
      <small>
        <strong>SnowFleaMarket Terms &#38; Conditions:</strong> This document is
        an electronic record in terms of the Information Technology Act, 2000 and
        rules thereunder as applicable and the amended provisions pertaining to
        electronic records in various statutes as amended by the Information
        Technology Act, 2000. This electronic record is generated by a computer
        system and does not require any physical or digital signatures.
      </small>
    </div>
    
    <!-- Select Shipping Address -->
    <div class="col-md-4">
      <h4>Select Shipping Address</h4>
      <hr />
      <form method="post" id="myform">
        {% csrf_token %}
        {% for ad in add %}
        <div class="card mb-3">
          <div class="card-body">
            <h5>{{ ad.name }}</h5>
            <p>{{ ad.locality }}, {{ ad.city }}, {{ ad.state }}, {{ ad.zipcode }}</p>
          </div>
        </div>
        <div class="form-check mb-4">
          <input
            class="form-check-input"
            type="radio"
            name="cust_id"
            id="custadd{{ forloop.counter }}"
            value="{{ ad.id }}"
            required
          />
          <label
            class="form-check-label fw-bold"
            for="custadd{{ forloop.counter }}"
          >
            Address {{ forloop.counter }}
          </label>
        </div>
        {% endfor %}
        <div class="text-end">
          <button id="rzp-button1" type="button" class="btn btn-primary">Pay with Razorpay</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock main-content %}
{% block payment-gateway %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  var options = {
    "key": "rzp_test_96Z24vMDhZdMqV", // Enter the Key ID generated from the Dashboard
    "amount": "{{ razorpayamount }}", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "ShoppingKart", // Your business name
    "description": "Test Transaction",
    "order_id": "{{ order_id }}", // This is a sample Order ID. Pass the `id` obtained in the response of Step 1
    "handler": function (response) {
      var form = document.getElementById('myform');
      var cust_id = form.querySelector('input[name="cust_id"]:checked').value;
      var url = `http://localhost:8000/paymentdone?order_id=${response.razorpay_order_id}&payment_id=${response.razorpay_payment_id}&cust_id=${cust_id}`;
      window.location.href = url;
    },
    "prefill": {
      "name": "Gaurav Kumar", // Your customer's name
      "email": "gaurav.kumar@example.com",
      "contact": "9000090000" // Provide the customer's phone number for better conversion rates 
    },
    "notes": {
      "address": "Razorpay Corporate Office"
    },
    "theme": {
      "color": "#3399cc"
    }
  };

  var rzp1 = new Razorpay(options);
  rzp1.on('payment.failed', function (response) {
    alert(response.error.description);
  });

  document.getElementById('rzp-button1').onclick = function (e) {
    var form = document.getElementById('myform');
    var addressSelected = form.querySelector('input[name="cust_id"]:checked');

    if (!addressSelected) {
      alert('Please select a shipping address.');
      e.preventDefault(); // Prevents the Razorpay popup from opening
    } else {
      rzp1.open();
      e.preventDefault(); // Prevents the default form submission
    }
  }
</script>
{% endblock payment-gateway %}
